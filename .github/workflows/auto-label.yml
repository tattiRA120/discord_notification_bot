name: Auto Label Safe Preview

on:
  workflow_run:
    workflows: ["CodeQL", "Dependency Review"]
    types:
      - completed

permissions:
  pull-requests: write
  actions: write

jobs:
  label-if-secure:
    name: Label Safe Preview
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request' }}
    steps:
      - name: Check Security Workflows
        uses: actions/github-script@v8
        with:
          script: |
            const head_sha = context.payload.workflow_run.head_sha;
            console.log(`Checking workflows for commit: ${head_sha}`);

            // 1. Find the PR associated with this commit
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: head_sha,
            });

            if (prs.data.length === 0) {
              console.log('No PR found for this commit.');
              return;
            }

            const pr = prs.data[0];
            console.log(`Found PR #${pr.number}: ${pr.title}`);

            // 2. Check changed files
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });

            const fileNames = files.data.map(f => f.filename);
            console.log('Files changed:', fileNames);

            const hasPythonChanges = fileNames.some(f => f.endsWith('.py') || f === 'requirements.txt');
            console.log(`Has Python changes: ${hasPythonChanges}`);

            // 3. Determine required workflows
            const requiredWorkflows = ['Dependency Review'];
            // We can also verify CodeQL if needed, but Dependency Review is the primary gate here alongside safe-chain
            if (hasPythonChanges) {
              requiredWorkflows.push('pr-safe-chain');
            }
            console.log('Required workflows:', requiredWorkflows);

            // 4. Check if we have success for required workflows
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: head_sha,
              status: 'success'
            });

            const finishedWorkflows = new Set(
              runs.data.workflow_runs
                .map(run => run.name)
            );

            console.log('Successful workflows found:', Array.from(finishedWorkflows));

            const allPassed = requiredWorkflows.every(name => finishedWorkflows.has(name));

            if (allPassed) {
              console.log('All security checks passed. Proceeding to label PR.');
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['safe-to-preview']
              });
              console.log(`Added 'safe-to-preview' label to PR #${pr.number}`);

              // Trigger auto-merge workflow
              console.log('Triggering dependabot-auto-merge workflow...');
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'dependabot-auto-merge.yml',
                ref: 'main', 
                inputs: {
                  pr_number: pr.number.toString()
                }
              });
              console.log('Available workflows triggered.');
            } else {
              console.log('Not all security checks have passed yet.');
              console.log(`Missing: ${requiredWorkflows.filter(name => !finishedWorkflows.has(name)).join(', ')}`);
            }
