name: Dependabot auto-merge
on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to merge'
        required: true

permissions:
  contents: write
  pull-requests: write
  checks: read
  actions: read
  statuses: read

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (
        (github.event.pull_request.user.login == 'dependabot[bot]' || github.event.pull_request.user.login == 'app/dependabot' || github.event.pull_request.user.login == 'tattiRA120') &&
        contains(join(github.event.pull_request.labels.*.name, ','), 'safe-to-preview')
      )
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PR_URL: ${{ github.event.pull_request.html_url }}
      PR_NUMBER: ${{ inputs.pr_number }}
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: SetUp auto-merge
        id: auto-merge
        uses: dependabot/fetch-metadata@v2.5.0
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if all workflows have passed
        run: |
          if [ -n "${{ inputs.pr_number }}" ]; then
            PR_URL="https://github.com/${{ github.repository }}/pull/${{ inputs.pr_number }}"
          else
            PR_URL="${{ github.event.pull_request.html_url }}"
          fi
          
          echo "PR_URL=$PR_URL" >> $GITHUB_ENV
          echo "Checking status for PR: $PR_URL"

          INTERVAL=10
          MAX_RETRIES=180 # 30 mins max
          CURRENT_WORKFLOW="Dependabot auto-merge"

          echo "üîç Starting stylish status check monitoring..."

          for ((i=1; i<=MAX_RETRIES; i++)); do
            # Fetch statuses
            # Returns: <Name>|<Status> per line
            # Handle empty fields gracefully using jq select/alternatives
            CHECKS=$(gh pr view "$PR_URL" --json statusCheckRollup -q "[.statusCheckRollup[] | select(type == \"object\") | {name: (if .workflowName and (.workflowName|length > 0) then .workflowName else .name // .context end), status: (if .__typename == \"CheckRun\" then (if .status == \"COMPLETED\" then .conclusion else .status end) else .state end) | ascii_upcase, date: (if .completedAt then .completedAt else .startedAt end)} | select(.name != \"$CURRENT_WORKFLOW\")] | group_by(.name) | map(max_by(.date // \"\")) | .[] | \"\(.name)|\(.status)\"")

            if [ -z "$CHECKS" ]; then
              echo "‚ö†Ô∏è No other checks found. Assuming safe to merge."
              exit 0
            fi

            PENDING=0
            FAILED=0
            PASSED=0

            echo "---------------------------------------------------"
            echo "üîÑ Attempt $i/$MAX_RETRIES"

            while IFS='|' read -r name status; do
              case "$status" in
                SUCCESS|SKIPPED|NEUTRAL)
                  echo "‚úÖ $name"
                  ((PASSED+=1))
                  ;;
                FAILURE|CANCELLED|TIMED_OUT|ACTION_REQUIRED|ERROR)
                  echo "‚ùå $name ($status)"
                  ((FAILED+=1))
                  ;;
                *)
                  echo "‚è≥ $name ($status)"
                  ((PENDING+=1))
                  ;;
              esac
            done <<< "$CHECKS"

            echo "---------------------------------------------------"
            echo "üìä Passed: $PASSED | Pending: $PENDING | Failed: $FAILED"

            if [ "$FAILED" -gt 0 ]; then
              echo "üö´ Critical check(s) failed. Aborting."
              exit 1
            fi

            if [ "$PENDING" -eq 0 ]; then
              echo "üéâ All checks passed! Ready to merge."
              exit 0
            fi

            echo "üí§ Waiting ${INTERVAL}s..."
            sleep $INTERVAL
          done

          echo "‚è∞ Timeout waiting for checks."
          exit 1
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Auto-merge for Dependabot PRs
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: gh pr merge --auto --merge "$PR_URL"
